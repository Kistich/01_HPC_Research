# 资源与任务整合分析工具

本工具用于将任务提交数据与服务器资源监控数据进行匹配和分析，以便更全面地了解计算集群的资源使用情况、任务特征与系统性能之间的关系。

## 功能概述

该分析工具主要实现以下功能：

1. **数据整合**：将任务提交记录与服务器资源监控数据（如CPU、GPU使用率、内存、负载、温度、能耗等）在时间和服务器维度上进行匹配。

2. **基础统计**：计算各种基本统计信息，如任务数量、服务器数量、用户数量等。

3. **资源使用分析**：分析各服务器组的资源使用情况，包括CPU、GPU使用率、系统负载等。

4. **时间模式分析**：通过热图展示不同服务器组在一周内各时间段的资源使用模式。

5. **用户行为分析**：分析用户的资源请求和使用模式，识别高资源消耗用户。

6. **资源效率分析**：比较任务请求的资源与实际使用的资源，评估资源利用效率。

## 文件说明

- **resource_job_integrator.py**: 主脚本文件，包含所有数据处理和分析功能

## 输入数据

该工具使用以下数据源：

1. **任务提交记录**：包含任务ID、用户ID、提交时间、开始时间、结束时间、执行服务器等信息。

2. **CPU使用率数据**：包含CPU总使用率和系统使用率数据。

3. **GPU使用率数据**：包含GPU平均使用率和GPUUtilization数据。

4. **内存使用数据**：包含内存使用率和已用内存量数据。

5. **系统负载数据**：包含1分钟和15分钟系统负载数据。

6. **能源数据**：包含服务器功率和温度数据。

## 输出结果

分析结果保存在 `/mnt/raid/liuhongbin/job_analysis/job_analysis/Combined_Analysis/results` 目录下，包括：

1. **整合数据集**：包含匹配后的任务和资源数据。

2. **基本统计信息**：任务、服务器、用户等基本统计信息。

3. **各种图表**：
   - 资源使用与任务数量关系图
   - 服务器组使用模式热图
   - 用户资源使用情况图
   - 资源效率分析图

## 主要函数说明

### 数据读取与处理函数

- **read_job_data(file_path)**: 读取任务提交数据
- **read_excel_resource_data(file_path, resource_type)**: 读取Excel格式的资源监控数据
- **match_jobs_with_resources(jobs_df, resources)**: 将任务数据与资源监控数据匹配

### 数据分析函数

- **analyze_combined_data(matched_df)**: 分析整合后的数据并生成基本统计报告
- **generate_resource_job_correlation_plots(matched_df, output_dir)**: 生成资源使用与任务数量关系图
- **generate_user_resource_analysis(matched_df, output_dir)**: 生成用户资源使用分析
- **generate_server_group_patterns(matched_df, output_dir)**: 生成服务器组使用模式分析
- **generate_resource_efficiency_analysis(matched_df, output_dir)**: 生成资源效率分析

### 辅助函数

- **parse_datetime(dt_str)**: 解析日期时间字符串
- **should_exclude_server(server_name)**: 检查服务器名称是否应该被排除
- **identify_server_group(server_name)**: 识别服务器所属的组
- **extract_server_id_from_exec_hosts(exec_hosts)**: 从exec_hosts字段提取服务器ID列表

## 运行方法


## 分析结果解读

### 1. 基本统计信息

基本统计信息包括总记录数、时间范围、服务器数量、任务数量和用户数量等。这些信息有助于了解数据集的规模和覆盖范围。

### 2. 资源使用与任务关系

这部分分析展示了任务数量与资源使用（如CPU使用率、GPU使用率、系统负载等）之间的关系。通过这些关系图，可以了解任务数量增加如何影响系统资源使用。

### 3. 服务器组使用模式

热图显示了不同服务器组在一周的各时间段（按小时和星期）的资源使用模式。这有助于识别使用高峰时段和低谷时段，优化资源调度。

### 4. 用户资源使用分析

这部分分析揭示了哪些用户提交的任务最多，以及这些用户申请了多少资源。这有助于识别高资源消耗用户，调整资源分配策略。

### 5. 资源效率分析

通过比较任务申请的资源与实际使用的资源，可以评估资源利用效率。这有助于识别资源浪费情况，优化资源分配。

## 注意事项

1. 本工具会自动过滤国产服务器的数据，以便更准确地进行匹配分析。

2. 时间窗口匹配采用1小时粒度，这可能会导致短时任务的资源使用情况被平均化。

3. 任务与资源的匹配基于服务器ID和时间窗口，匹配质量取决于原始数据的完整性和准确性。